<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" />
<title>Precifica√ß√£o ‚Ä¢ Doceria</title>
<meta name="theme-color" content="#9C7050"/>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --brown:#9C7050;
    --gold:#C8AD57;
    --cream:#F3EAC1;
    --white:#ffffff;
    --muted:#7b6657;
    --success:#2f8a56;
    --danger:#d9534f;
    --card-border: rgba(156,112,80,0.12);
    --radius:14px;
    font-family: Inter, "Segoe UI", Roboto, system-ui, -apple-system, "Helvetica Neue", Arial;
  }

  html,body{height:100%;margin:0;background:linear-gradient(180deg,#fbf6e8,var(--cream));-webkit-font-smoothing:antialiased}
  .app{max-width:440px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;padding:18px 12px 100px;}
  header.app-header{
    display:flex;align-items:center;gap:12px;padding:12px;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,0.85),#fff);
    box-shadow:0 8px 30px rgba(0,0,0,0.06);border:1px solid var(--card-border);backdrop-filter: blur(6px);
    position:relative;overflow:hidden;
  }

  /* logo: show only image (no square background) */
  .logo-wrap{width:56px;height:56px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
  .logo-wrap img{width:48px;height:48px;object-fit:contain;border-radius:10px;display:block}

  h1{font-size:16px;margin:0;color:var(--brown)}
  p.subtitle{margin:0;color:var(--muted);font-size:12px}
  main.content{margin-top:12px;flex:1;display:flex;flex-direction:column;gap:12px}

  .card{background: linear-gradient(180deg,#fff,#fff);padding:12px;border-radius:14px;box-shadow:0 8px 20px rgba(0,0,0,0.06);border:1px solid var(--card-border);overflow:hidden}
  label{font-size:12px;color:var(--muted);font-weight:700;margin-bottom:6px;display:block}
  input[type="number"], input[type="text"], select, textarea{
    padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:#fff;font-size:14px;color:var(--brown);
    width:100%;box-sizing:border-box;
  }

  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .row{display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:13px}
  .muted-small{color:var(--muted);font-size:12px}
  .btn{background:var(--brown);color:var(--white);padding:10px 12px;border-radius:10px;border:none;font-weight:700;cursor:pointer;transition:transform .12s, box-shadow .12s}
  .btn:hover{transform:translateY(-3px);box-shadow:0 8px 18px rgba(0,0,0,0.08)}
  .btn.secondary{background:transparent;color:var(--brown);border:2px solid var(--gold)}
  .small-ghost{background:transparent;border:1px dashed rgba(0,0,0,0.06);padding:8px;border-radius:8px;cursor:pointer}
  .products-list{display:grid;gap:10px}
  .product-row{display:flex;flex-direction:column;gap:8px;padding:10px;border-radius:12px;border:1px solid rgba(220,210,190,0.6);background:linear-gradient(180deg,#fff,#fdf8ef)}
  .product-row .name{font-weight:800;color:var(--brown)}
  .pill{background:var(--gold);color:var(--brown);padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px}
  .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px}
  .summary-box{padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fff);border:1px solid var(--card-border)}
  .summary-box .v{font-weight:800;color:var(--brown);font-size:16px}
  .footer-bar{position:fixed;left:0;right:0;bottom:12px;max-width:440px;margin:0 auto;background:linear-gradient(180deg,#fff,var(--cream));padding:10px;border-radius:999px;border:1px solid rgba(0,0,0,0.04);display:flex;gap:6px;align-items:center;justify-content:space-around;box-shadow:0 -10px 30px rgba(0,0,0,0.06)}
  .tab-btn{flex:1;display:flex;flex-direction:column;align-items:center;gap:6px;padding:6px;border-radius:10px;color:var(--muted);font-weight:700;cursor:pointer;transition:all .18s}
  .tab-btn.active{background:linear-gradient(180deg,var(--gold),#e7cc87);color:var(--brown);transform:translateY(-6px);box-shadow:0 8px 18px rgba(0,0,0,0.08)}
  .chart-wrap{height:160px}
  .animate-fade{animation:fadeInUp .36s both ease-out}
  @keyframes fadeInUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}

  /* responsive tweaks */
  @media (max-width:420px){
    .app{padding:12px 10px 100px}
    .logo-wrap{width:46px;height:46px}
  }
</style>
</head>
<body>
  <div class="app" id="app">
    <header class="app-header">
      <!-- Use your logo file inside assets/ (example: assets/banana-canela-logo.png) -->
      <div class="logo-wrap"><img src="assets/banana-canela-logo.png" alt="Logo" id="logoImg" /></div>
      <div style="flex:1">
        <h1>Precifica√ß√£o ‚Ä¢ Doceria</h1>
        <p class="subtitle">Calc. CMV ¬∑ Markup 3√ó ¬∑ iFood ¬∑ Offline</p>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn small secondary" id="btnReset">Reset</button>
      </div>
    </header>

    <main class="content" id="content">
      <!-- Custos Fixos (antes Configura√ß√µes) -->
      <section id="tab-config" class="card animate-fade">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Custos Fixos</strong><div class="muted">Defina custos fixos, meta e canais</div></div>
          <div><button class="small-ghost" id="btnSaveManual">Salvar</button></div>
        </div>

        <div style="margin-top:12px" class="grid-3">
          <div><label>Aluguel (R$)</label><input type="number" id="aluguel" value="1500" /></div>
          <div><label>Energia (R$)</label><input type="number" id="energia" value="300" /></div>
          <div><label>√Ågua (R$)</label><input type="number" id="agua" value="30" /></div>
        </div>

        <div style="margin-top:10px" class="grid-3">
          <div><label>Internet (R$)</label><input type="number" id="internet" value="100" /></div>
          <div><label>Telefone (R$)</label><input type="number" id="telefone" value="30" /></div>
          <div><label>G√°s (R$)</label><input type="number" id="gas" value="110" /></div>
        </div>

        <div style="margin-top:10px" class="grid-3">
          <div><label>Marketing (R$)</label><input type="number" id="marketing" value="400" /></div>
          <div><label>Taxas fixas apps (R$)</label><input type="number" id="taxasApps" value="130" /></div>
          <div><label>Taxa iFood (%)</label><input type="number" id="taxaIfood" value="23" /></div>
        </div>

        <div style="margin-top:12px" class="grid-2">
          <div><label>Meta de lucro mensal (R$)</label><input type="number" id="metaLucroMensal" value="3500" /></div>
          <div><label>% Absor√ß√£o progressiva (fixos no pre√ßo)</label><input type="number" id="absorcaoProgressiva" value="30" /></div>
        </div>

        <div style="margin-top:12px">
          <label>Distribui√ß√£o de canais (modifique para simular)</label>
          <div style="display:flex;gap:8px;margin-top:6px">
            <input type="number" id="percVendasDiretas" value="70" style="width:40%" />
            <input type="number" id="percVendasIfood" value="30" style="width:40%" />
            <div class="muted" style="align-self:center">Total: <span id="distTotal">100%</span></div>
          </div>
        </div>

        <!-- M√£o de obra -->
        <div style="margin-top:12px" class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>M√£o de Obra</strong><div class="muted">Insira funcion√°rios / colaboradores</div></div>
            <div><button class="btn small" id="btnAddLabor">+ Pessoa</button></div>
          </div>

          <div style="margin-top:10px;overflow:auto">
            <table style="width:100%;margin-top:10px" id="laborTable">
              <thead>
                <tr>
                  <th style="text-align:left">Nome</th>
                  <th style="text-align:left">Fun√ß√£o</th>
                  <th>R$/h</th>
                  <th>Horas/m√™s</th>
                  <th>Total/m√™s</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="laborTableBody"></tbody>
            </table>
          </div>

          <div style="margin-top:12px" class="grid-2">
            <div class="summary-box"><div class="muted-small">Total Horas/M√™s</div><div class="v" id="totalHoras">0h</div></div>
            <div class="summary-box"><div class="muted-small">Custo Hora M√©dio</div><div class="v" id="custoHoraMedio">R$ 0,00</div></div>
          </div>
        </div>

      </section>

      <!-- Produtos -->
      <section id="tab-products" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Produtos</strong><div class="muted">Cadastre seus produtos (edite valores)</div></div>
          <div style="display:flex;gap:8px">
            <button class="btn small" id="btnAddProduct">+ Produto</button>
            <button class="small-ghost" id="btnNormalize">Normalizar %</button>
          </div>
        </div>

        <div style="margin-top:12px" id="productsContainer" class="products-list">
          <!-- dynamic product UI will be inserted here -->
        </div>
      </section>

      <!-- Resultados -->
      <section id="tab-results" class="card" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Resultados</strong><div class="muted">Faturamento m√≠nimo e vendas necess√°rias por produto</div></div>
        </div>

        <div style="margin-top:12px" class="summary-grid">
          <div class="summary-box"><div class="muted">Custos Fixos Totais</div><div class="v" id="fixedTotal">R$ 0,00</div></div>
          <div class="summary-box"><div class="muted">Meta Lucro</div><div class="v" id="metaVal">R$ 0,00</div></div>
          <div class="summary-box"><div class="muted">Faturamento M√≠nimo</div><div class="v" id="faturamentoMin">R$ 0,00</div></div>
          <div class="summary-box"><div class="muted">Custo Hora M√©dio</div><div class="v" id="custoHoraMedioResult">R$ 0,00</div></div>
        </div>

        <div style="margin-top:12px">
          <strong>Quantidade m√≠nima necess√°ria por produto</strong>
          <div id="qtdResult" style="margin-top:8px"></div>
        </div>

        <div style="margin-top:12px">
          <strong>An√°lises</strong>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:8px">
            <div class="card">
              <div class="muted-small">Distribui√ß√£o de participa√ß√£o</div>
              <div class="chart-wrap"><canvas id="participChart"></canvas></div>
            </div>
            <div class="card">
              <div class="muted-small">CMV m√©dio ponderado</div>
              <div class="chart-wrap"><canvas id="cmvChart"></canvas></div>
            </div>
          </div>
        </div>

      </section>
    </main>

    <nav class="footer-bar" id="footer">
      <div class="tab-btn active" data-tab="config" id="tabbtn-config">‚öôÔ∏è Custos Fixos</div>
      <div class="tab-btn" data-tab="products" id="tabbtn-products">üç∞ Produtos</div>
      <div class="tab-btn" data-tab="results" id="tabbtn-results">üìä Resultados</div>
    </nav>
  </div>

<script>
/* ========== STATE & STORAGE ========== */
const STORAGE_KEY = 'doceria_precificacao_v3';
let state = {
  config:{
    aluguel:1500,energia:300,agua:30,internet:100,telefone:30,gas:110,marketing:400,taxasApps:130,
    taxaIfood:23,percVendasDiretas:70,percVendasIfood:30,absorcaoProgressiva:30,metaLucroMensal:3500
  },
  labor:[
    { id: 'l1', name:'Propriet√°rio', role:'Dono', hourlyRate:12, hoursMonth:264 }
  ],
  products:[]
};

function loadState(){ try{ const r = localStorage.getItem(STORAGE_KEY); if(r) state = JSON.parse(r); } catch(e){ console.warn(e) } }
function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); showToast('Salvo localmente'); } catch(e){ console.warn(e); showToast('Erro ao salvar') } }
loadState();

/* ========== HELPERS ========== */
const $ = id => document.getElementById(id);
function money(v){ return 'R$ ' + Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function uid(prefix='id'){ return prefix + Math.random().toString(36).slice(2,9); }
function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }
function showToast(msg, ms=1400){
  const t = document.createElement('div'); t.textContent=msg;
  t.style.cssText='position:fixed;right:16px;top:16px;background:var(--brown);color:#fff;padding:10px 12px;border-radius:10px;z-index:9999;font-weight:700';
  document.body.appendChild(t); setTimeout(()=>t.remove(),ms);
}

/* ========== RENDER UI ========== */

/* Config render */
function renderConfig(){
  const c = state.config;
  $('aluguel').value = c.aluguel||0;
  $('energia').value = c.energia||0;
  $('agua').value = c.agua||0;
  $('internet').value = c.internet||0;
  $('telefone').value = c.telefone||0;
  $('gas').value = c.gas||0;
  $('marketing').value = c.marketing||0;
  $('taxasApps').value = c.taxasApps||0;
  $('taxaIfood').value = c.taxaIfood||0;
  $('percVendasDiretas').value = c.percVendasDiretas||0;
  $('percVendasIfood').value = c.percVendasIfood||0;
  $('absorcaoProgressiva').value = c.absorcaoProgressiva||0;
  $('metaLucroMensal').value = c.metaLucroMensal||0;
  updateDistributionTotal();
}

/* Labor render */
function renderLaborTable(){
  const tbody = $('laborTableBody');
  tbody.innerHTML = '';
  state.labor.forEach((row, idx) => {
    const total = (Number(row.hourlyRate)||0) * (Number(row.hoursMonth)||0);
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input type="text" value="${row.name||''}" onchange="updateLabor('${row.id}','name',this.value)"></td>
      <td><input type="text" value="${row.role||''}" onchange="updateLabor('${row.id}','role',this.value)"></td>
      <td><input type="number" step="0.01" value="${row.hourlyRate||0}" onchange="updateLabor('${row.id}','hourlyRate',parseFloat(this.value)||0)"></td>
      <td><input type="number" value="${row.hoursMonth||0}" onchange="updateLabor('${row.id}','hoursMonth',parseInt(this.value)||0)"></td>
      <td class="calc-cell">${money(total)}</td>
      <td><button class="small-ghost" onclick="removeLabor('${row.id}')">Remover</button></td>
    `;
    tbody.appendChild(tr);
  });
  calculateLabor();
}

/* Products UI (compact table) */
function renderProducts(){
  const container = $('productsContainer');
  container.innerHTML = '';
  if(state.products.length === 0){
    const empty = document.createElement('div'); empty.className='muted'; empty.textContent='Nenhum produto cadastrado. Clique em + Produto';
    container.appendChild(empty); return;
  }

  state.products.forEach((p, idx) => {
    const block = document.createElement('div'); block.className='product-row';
    block.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
        <div style="flex:1">
          <div style="font-weight:800;color:var(--brown)">${p.name}</div>
          <div class="muted-small">Rend.: ${p.unitsPerRecipe} un ‚Ä¢ Embalagem: ${p.unitsPerPackage} ‚Ä¢ Tempo: ${p.productionTime}h</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px">
          <button class="small-ghost" onclick="editProduct('${p.id}')">Editar</button>
          <button class="small-ghost" onclick="duplicateProduct('${p.id}')">Duplicar</button>
        </div>
      </div>
    `;
    container.appendChild(block);
  });
}

/* Product editor modal (simple inline) */
function editProduct(id){
  const p = state.products.find(x=>x.id===id);
  if(!p) return;
  const overlay = document.createElement('div');
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;padding:16px';
  const box = document.createElement('div');
  box.style.cssText = 'background:#fff;border-radius:12px;padding:16px;max-width:520px;width:100%;max-height:90%;overflow:auto';
  box.innerHTML = `
    <h3 style="margin:0 0 10px 0;color:var(--brown)">${p.name}</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div><label>Nome</label><input id="ep_name" type="text" value="${p.name}"></div>
      <div><label>Participa√ß√£o %</label><input id="ep_part" type="number" step="0.01" value="${p.participationPercent||0}"></div>
      <div><label>Un/receita</label><input id="ep_unitsRecipe" type="number" value="${p.unitsPerRecipe||1}"></div>
      <div><label>Un/embalagem</label><input id="ep_unitsPack" type="number" value="${p.unitsPerPackage||1}"></div>
      <div><label>Custo ingredientes (R$)</label><input id="ep_ing" type="number" step="0.01" value="${p.ingredientCost||0}"></div>
      <div><label>Custo embalagem (R$)</label><input id="ep_pack" type="number" step="0.01" value="${p.packagingCost||0}"></div>
      <div><label>Tempo produ√ß√£o (h)</label><input id="ep_time" type="number" step="0.1" value="${p.productionTime||0}"></div>
      <div><label>Margem %</label><input id="ep_margin" type="number" step="0.01" value="${p.marginPercent||state.config.margemLucro||35}"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
      <button class="btn" id="ep_save">Salvar</button>
      <button class="small-ghost" id="ep_cancel">Cancelar</button>
    </div>
  `;
  overlay.appendChild(box);
  document.body.appendChild(overlay);

  $('#ep_cancel').addEventListener('click', ()=> overlay.remove());
  $('#ep_save').addEventListener('click', ()=>{
    p.name = $('#ep_name').value || p.name;
    p.participationPercent = parseFloat($('#ep_part').value)||0;
    p.unitsPerRecipe = parseInt($('#ep_unitsRecipe').value)||1;
    p.unitsPerPackage = parseInt($('#ep_unitsPack').value)||1;
    p.ingredientCost = parseFloat($('#ep_ing').value)||0;
    p.packagingCost = parseFloat($('#ep_pack').value)||0;
    p.productionTime = parseFloat($('#ep_time').value)||0;
    p.marginPercent = parseFloat($('#ep_margin').value)|| (p.marginPercent||35);
    saveState(); renderProducts(); calculateResults();
    overlay.remove();
  });
}

function duplicateProduct(id){
  const p = state.products.find(x=>x.id===id);
  if(!p) return;
  const copy = JSON.parse(JSON.stringify(p));
  copy.id = uid('p');
  copy.name = copy.name + ' (copy)';
  state.products.push(copy);
  saveState(); renderProducts(); calculateResults();
}

/* ========== SAMPLE PRODUCTS ========== */
function addDefaultSampleProductsIfEmpty(){
  if(state.products.length === 0){
    state.products.push({ id: uid('p'), name:'Alfajor Maizena (caixa 6)', unitsPerRecipe:36, unitsPerPackage:6, ingredientCost:11.71, packagingCost:1.20, productionTime:2, participationPercent:40, marginPercent:35 });
    state.products.push({ id: uid('p'), name:'Brownie (un)', unitsPerRecipe:6, unitsPerPackage:1, ingredientCost:24.42, packagingCost:1.00, productionTime:1, participationPercent:30, marginPercent:35 });
    state.products.push({ id: uid('p'), name:'Cookie recheado (90g)', unitsPerRecipe:8, unitsPerPackage:1, ingredientCost:36.23, packagingCost:1.00, productionTime:1.5, participationPercent:30, marginPercent:35 });
    saveState();
  }
}

/* ========== CALCULATIONS ========== */

/* labor totals */
function getLaborTotals(){
  let totalHours=0, totalCost=0;
  state.labor.forEach(l=>{
    totalHours += Number(l.hoursMonth||0);
    totalCost += (Number(l.hourlyRate)||0) * (Number(l.hoursMonth)||0);
  });
  return { totalHours, totalCost };
}

/* fixed costs (operational) */
function getFixedCostsOperational(){
  const c = state.config;
  const fields = ['aluguel','energia','agua','internet','telefone','gas','marketing','taxasApps'];
  let sum = 0;
  fields.forEach(f=> sum += Number(c[f]||0));
  return sum;
}
function getFixedCostsTotal(){
  return getFixedCostsOperational() + getLaborTotals().totalCost;
}

/* calculating for each product (used for charts and results) */
function calculatePerProduct(p){
  // normalize property names compatibility
  const unitsPerRecipe = Number(p.unitsPerRecipe||p.unitsPerRecipe===0? p.unitsPerRecipe : 1);
  const unitsPerPackage = Number(p.unitsPerPackage||1);
  const ingredientCost = Number(p.ingredientCost||0);
  const packagingCost = Number(p.packagingCost||0);
  // labor
  const laborTotals = getLaborTotals();
  const avgHourly = laborTotals.totalHours > 0 ? laborTotals.totalCost / laborTotals.totalHours : 0;
  const productionTime = Number(p.productionTime||0);
  // labor cost per unit = (productionTime * avgHourly) / unitsPerRecipe
  const laborCostPerUnit = unitsPerRecipe > 0 ? (productionTime * avgHourly) / unitsPerRecipe : 0;
  const costPerUnit = ingredientCost + laborCostPerUnit;
  const costPerPackage = (costPerUnit * unitsPerPackage) + packagingCost;
  const absorcaoPct = Number(state.config.absorcaoProgressiva||0)/100;
  const fixedCostAbsorption = costPerPackage * absorcaoPct;
  const totalCostWithFixed = costPerPackage + fixedCostAbsorption;
  const marginPct = Number(p.marginPercent || state.config.margemLucro || 0)/100;
  const precoDireto = marginPct < 0.999 ? totalCostWithFixed / (1 - marginPct) : totalCostWithFixed;
  const taxaIfood = Number(state.config.taxaIfood||0)/100;
  const precoIfood = precoDireto / (1 - taxaIfood);
  const precoMarkup3 = costPerPackage * 3;
  const cmv = precoDireto > 0 ? (costPerPackage / precoDireto) * 100 : 0;
  const margemUnitaria = precoDireto - totalCostWithFixed;
  return { unitsPerRecipe, unitsPerPackage, ingredientCost, packagingCost, laborCostPerUnit, costPerUnit, costPerPackage, fixedCostAbsorption, totalCostWithFixed, precoDireto, precoIfood, precoMarkup3, cmv, margemUnitaria };
}

/* ========== RESULTS & CHARTS ========== */
let participationChart = null, cmvChart = null;

function calculateResults(){
  // fixed total
  const fixedTotal = getFixedCostsTotal();
  const metaLucro = Number(state.config.metaLucroMensal||0);
  const faturamentoMin = fixedTotal + metaLucro;
  $('fixedTotal').textContent = money(fixedTotal);
  $('metaVal').textContent = money(metaLucro);
  $('faturamentoMin').textContent = money(faturamentoMin);

  // avg hourly
  const labor = getLaborTotals();
  const avgHourly = labor.totalHours > 0 ? labor.totalCost / labor.totalHours : 0;
  $('custoHoraMedioResult').textContent = money(avgHourly);

  // quantity / per product
  const qdiv = $('qtdResult'); qdiv.innerHTML = '';
  let totalParticipation = 0; state.products.forEach(pp=> totalParticipation += Number(pp.participationPercent||0));
  if(totalParticipation <= 0){
    qdiv.innerHTML = '<div class="muted">Defina as % de participa√ß√£o dos produtos para calcular distribui√ß√£o.</div>';
  } else {
    if(Math.abs(totalParticipation - 100) > 0.1){
      const warn = document.createElement('div'); warn.className='muted'; warn.style.marginBottom='8px';
      warn.innerHTML = `‚ö†Ô∏è A soma das participa√ß√µes = ${totalParticipation.toFixed(1)}%. (use "Normalizar %" para ajustar)`;
      qdiv.appendChild(warn);
    }

    const labels = [], dataPct = [], dataCMV = [];

    state.products.forEach(p=>{
      const calc = calculatePerProduct(p);
      const particip = Number(p.participationPercent||0);
      const faturamentoProduto = faturamentoMin * (particip/100);
      const qtdNecessaria = calc.margemUnitaria > 0 ? Math.ceil(faturamentoProduto / calc.margemUnitaria) : 0;

      // item block
      const item = document.createElement('div'); item.className='product-row';
      item.style.display='flex'; item.style.flexDirection='column';
      item.innerHTML = `<div style="display:flex;justify-content:space-between"><div style="font-weight:800;color:var(--brown)">${p.name}</div><div class="pill">${particip.toFixed(1)}%</div></div>
                        <div style="display:flex;justify-content:space-between;margin-top:8px">
                          <div class="muted-small">Pre√ßo Direto: <strong>${money(calc.precoDireto)}</strong> ‚Ä¢ iFood: <strong>${money(calc.precoIfood)}</strong></div>
                          <div style="text-align:right"><div class="muted-small">CMV ${calc.cmv.toFixed(1)}%</div><div style="font-weight:800">${qtdNecessaria} un/m√™s</div></div>
                        </div>`;
      qdiv.appendChild(item);

      labels.push(p.name);
      dataPct.push(particip);
      dataCMV.push(calc.cmv);
    });

    updateCharts(labels, dataPct, dataCMV);
  }

  // update comparatives small (if present)
  // (we don't render separate boxes now - kept calculation)
}

/* chart render */
function updateCharts(labels, dataPct, dataCMV){
  const ctx = $('participChart').getContext('2d');
  const ctx2 = $('cmvChart').getContext('2d');
  if(participationChart) participationChart.destroy();
  participationChart = new Chart(ctx, {
    type:'doughnut',
    data:{ labels, datasets:[{ data: dataPct, backgroundColor: generateColors(labels.length) }]},
    options:{ plugins:{legend:{display:true, position:'bottom'}}, maintainAspectRatio:false }
  });

  if(cmvChart) cmvChart.destroy();
  cmvChart = new Chart(ctx2, {
    type:'bar',
    data:{ labels, datasets:[{ label:'CMV %', data: dataCMV, backgroundColor: generateColors(labels.length) }]},
    options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}, maintainAspectRatio:false }
  });
}
function generateColors(n){
  const p = ['#C8AD57','#9C7050','#F2D9A7','#E3C89A','#D8B77C','#EEDFC8','#B78A60','#F7E6C1'];
  const out=[]; for(let i=0;i<n;i++) out.push(p[i%p.length]); return out;
}

/* ========== UI EVENTS & Interactions ========== */

/* update state from UI (costs) */
function updateStateFromUI(){
  const c = state.config;
  c.aluguel = Number($('aluguel').value||0);
  c.energia = Number($('energia').value||0);
  c.agua = Number($('agua').value||0);
  c.internet = Number($('internet').value||0);
  c.telefone = Number($('telefone').value||0);
  c.gas = Number($('gas').value||0);
  c.marketing = Number($('marketing').value||0);
  c.taxasApps = Number($('taxasApps').value||0);
  c.taxaIfood = Number($('taxaIfood').value||0);
  c.percVendasDiretas = Number($('percVendasDiretas').value||0);
  c.percVendasIfood = Number($('percVendasIfood').value||0);
  c.absorcaoProgressiva = Number($('absorcaoProgressiva').value||0);
  c.metaLucroMensal = Number($('metaLucroMensal').value||0);
  saveState(); updateDistributionTotal();
}

/* distribution total display */
function updateDistributionTotal(){
  const a = Number($('percVendasDiretas').value||0);
  const b = Number($('percVendasIfood').value||0);
  $('distTotal').textContent = (a+b).toFixed(1) + '%';
}

/* labor manipulation */
function addLabor(){
  state.labor.push({ id: uid('l'), name:'Novo', role:'', hourlyRate:0, hoursMonth:0});
  saveState(); renderLaborTable(); renderConfig(); calculateResults();
}
function updateLabor(id, field, value){
  const r = state.labor.find(x=>x.id===id);
  if(!r) return;
  r[field] = value;
  saveState(); renderLaborTable(); calculateResults();
}
function removeLabor(id){
  state.labor = state.labor.filter(x=>x.id!==id);
  saveState(); renderLaborTable(); calculateResults();
}

/* products manipulation */
function addProduct(){
  if(state.products.length >= 20){ showToast('Limite 20 produtos atingido'); return; }
  const p = { id: uid('p'), name:'Novo Produto', unitsPerRecipe:1, unitsPerPackage:1, ingredientCost:0, packagingCost:0, productionTime:0.5, participationPercent:0, marginPercent:35 };
  state.products.push(p); saveState(); renderProducts(); calculateResults();
}
function removeProduct(id){
  state.products = state.products.filter(x=>x.id!==id);
  saveState(); renderProducts(); calculateResults();
}
function normalizePercents(){
  let sum = 0; state.products.forEach(p=> sum += Number(p.participationPercent||0));
  if(sum === 0) { showToast('Soma zero ‚Äî atribua % antes de normalizar'); return; }
  state.products.forEach(p=> p.participationPercent = (Number(p.participationPercent||0)/sum)*100 );
  saveState(); renderProducts(); calculateResults();
}

/* small product table editing is in modal 'editProduct' above */

/* event listeners for buttons */
document.getElementById('btnAddLabor').addEventListener('click', addLabor);
document.getElementById('btnAddProduct').addEventListener('click', addProduct);
document.getElementById('btnNormalize').addEventListener('click', normalizePercents);
document.getElementById('btnSaveManual').addEventListener('click', ()=>{ updateStateFromUI(); showToast('Config salva'); });
document.getElementById('btnReset').addEventListener('click', ()=>{ if(confirm('Resetar dados locais?')){ localStorage.removeItem(STORAGE_KEY); location.reload(); } });

/* live update inputs */
['aluguel','energia','agua','internet','telefone','gas','marketing','taxasApps','taxaIfood','percVendasDiretas','percVendasIfood','absorcaoProgressiva','metaLucroMensal'].forEach(id=>{
  const el = $(id); if(!el) return;
  el.addEventListener('input', ()=>{ updateStateFromUI(); calculateResults(); });
});

/* TAB NAV */
const tabButtons = document.querySelectorAll('.tab-btn');
const tabs = {
  config: $('tab-config'),
  products: $('tab-products'),
  results: $('tab-results')
};
function showTab(tabName){
  Object.values(tabs).forEach(t => t.style.display = 'none');
  tabButtons.forEach(b => b.classList.remove('active'));
  const btn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
  if(btn) btn.classList.add('active');
  if(tabs[tabName]) tabs[tabName].style.display = 'block';
  if(tabName === 'results') calculateResults();
}
tabButtons.forEach(btn=> btn.addEventListener('click', ()=> showTab(btn.dataset.tab) ) );
showTab('config');

/* ========== INIT ========== */
addDefaultSampleProductsIfEmpty();
renderConfig();
renderLaborTable();
renderProducts();
calculateResults();
saveState();

</script>
</body>
</html>
